name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      cloud_provider:
        description: 'Cloud provider to rollback'
        required: true
        type: choice
        options:
          - all
          - aws
          - gcp
          - azure
          - vercel
      rollback_to:
        description: 'Rollback target (commit SHA, tag, or "previous")'
        required: true
        default: 'previous'
      include_database:
        description: 'Include database rollback'
        required: false
        type: boolean
        default: false

# Default permissions - minimal access
permissions:
  contents: read

env:
  ARTIFACT_RETENTION_COUNT: 5

jobs:
  validate-rollback:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      target_sha: ${{ steps.resolve.outputs.target_sha }}
      target_version: ${{ steps.resolve.outputs.target_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve rollback target
        id: resolve
        run: |
          TARGET="${{ github.event.inputs.rollback_to }}"
          
          if [ "$TARGET" == "previous" ]; then
            # Get the previous deployment
            TARGET_SHA=$(git rev-parse HEAD~1)
          elif [[ "$TARGET" =~ ^v[0-9] ]]; then
            # It's a tag
            TARGET_SHA=$(git rev-list -n 1 "$TARGET" 2>/dev/null || echo "")
          else
            # Assume it's a commit SHA
            TARGET_SHA="$TARGET"
          fi
          
          if [ -z "$TARGET_SHA" ]; then
            echo "Error: Could not resolve rollback target"
            exit 1
          fi
          
          # Verify the commit exists
          if ! git cat-file -e "$TARGET_SHA" 2>/dev/null; then
            echo "Error: Target commit $TARGET_SHA does not exist"
            exit 1
          fi
          
          TARGET_VERSION=$(git describe --tags --always "$TARGET_SHA" 2>/dev/null || echo "$TARGET_SHA")
          
          echo "target_sha=${TARGET_SHA}" >> $GITHUB_OUTPUT
          echo "target_version=${TARGET_VERSION}" >> $GITHUB_OUTPUT
          echo "Rollback target: ${TARGET_VERSION} (${TARGET_SHA})"

      - name: Confirm rollback
        run: |
          echo "## Rollback Confirmation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloud Provider | ${{ github.event.inputs.cloud_provider }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target Version | ${{ steps.resolve.outputs.target_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target SHA | ${{ steps.resolve.outputs.target_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Include Database | ${{ github.event.inputs.include_database }} |" >> $GITHUB_STEP_SUMMARY

  rollback-aws:
    name: Rollback AWS
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: validate-rollback
    if: github.event.inputs.cloud_provider == 'all' || github.event.inputs.cloud_provider == 'aws'
    environment:
      name: aws-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
        continue-on-error: true

      - name: Rollback Lambda function
        run: |
          echo "Rolling back AWS Lambda to version: ${{ needs.validate-rollback.outputs.target_version }}"
          # aws lambda update-function-code commands would go here
        continue-on-error: true

      - name: Verify rollback
        run: |
          echo "Verifying AWS rollback..."

  rollback-gcp:
    name: Rollback GCP
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: validate-rollback
    if: github.event.inputs.cloud_provider == 'all' || github.event.inputs.cloud_provider == 'gcp'
    environment:
      name: gcp-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        continue-on-error: true

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        continue-on-error: true

      - name: Rollback Cloud Function
        run: |
          echo "Rolling back GCP Cloud Function to version: ${{ needs.validate-rollback.outputs.target_version }}"
          # gcloud functions deploy commands would go here
        continue-on-error: true

      - name: Verify rollback
        run: |
          echo "Verifying GCP rollback..."

  rollback-azure:
    name: Rollback Azure
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: validate-rollback
    if: github.event.inputs.cloud_provider == 'all' || github.event.inputs.cloud_provider == 'azure'
    environment:
      name: azure-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Rollback Azure Function
        run: |
          echo "Rolling back Azure Function to version: ${{ needs.validate-rollback.outputs.target_version }}"
          # az functionapp deployment commands would go here
        continue-on-error: true

      - name: Verify rollback
        run: |
          echo "Verifying Azure rollback..."

  rollback-frontend:
    name: Rollback Frontend (Vercel)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: validate-rollback
    if: github.event.inputs.cloud_provider == 'all' || github.event.inputs.cloud_provider == 'vercel'
    environment:
      name: vercel-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Rollback Vercel deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "Rolling back Vercel to version: ${{ needs.validate-rollback.outputs.target_version }}"
          # Vercel rollback commands would go here
        continue-on-error: true

  rollback-database:
    name: Rollback Database
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: validate-rollback
    if: github.event.inputs.include_database == 'true'
    environment:
      name: database-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-rollback.outputs.target_sha }}

      - name: Validate database migration
        run: |
          echo "Validating database migration compatibility..."
          echo "Target version: ${{ needs.validate-rollback.outputs.target_version }}"

      - name: Execute database rollback
        run: |
          echo "Executing database rollback using expand-contract pattern..."
          echo "This is a placeholder for actual database migration rollback"

  health-check:
    name: Post-Rollback Health Check
    runs-on: ubuntu-latest
    permissions: {}
    needs: [validate-rollback, rollback-aws, rollback-gcp, rollback-azure, rollback-frontend]
    if: always()

    steps:
      - name: AWS Health Check
        if: needs.rollback-aws.result == 'success'
        run: echo "AWS health check passed"

      - name: GCP Health Check
        if: needs.rollback-gcp.result == 'success'
        run: echo "GCP health check passed"

      - name: Azure Health Check
        if: needs.rollback-azure.result == 'success'
        run: echo "Azure health check passed"

      - name: Frontend Health Check
        if: needs.rollback-frontend.result == 'success'
        run: echo "Frontend health check passed"

  notify-rollback:
    name: Send Rollback Notification
    runs-on: ubuntu-latest
    permissions: {}
    needs: [validate-rollback, rollback-aws, rollback-gcp, rollback-azure, rollback-frontend, health-check]
    if: always()

    steps:
      - name: Prepare notification
        run: |
          echo "## Rollback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AWS | ${{ needs.rollback-aws.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GCP | ${{ needs.rollback-gcp.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure | ${{ needs.rollback-azure.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.rollback-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify team
        run: |
          echo "Rollback completed to version: ${{ needs.validate-rollback.outputs.target_version }}"
