# ADE Fusion Stack CI/CD Pipeline
# Performance-tuned with pnpm caching and matrix builds
# Security: Actions pinned by digest on main branch

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
      - staging
  pull_request:
    branches:
      - main
      - dev
      - staging
  workflow_dispatch:

# Pin actions by SHA for main branch security (Rugged-Silo policy)
# On dev/staging, version tags are acceptable
env:
  # Action digests for main branch pinning
  # Periodically update these digests when updating action versions
  CHECKOUT_SHA: 'b4ffde65f46336ab88eb53be808477a3936bae11' # v4.1.1
  SETUP_NODE_SHA: '60edb5dd545a775178f52524783378180af0d1f8' # v4.0.2
  UPLOAD_ARTIFACT_SHA: '5d5d22a31266ced268874388b861e4b58bb5c2f3' # v4.3.1
  CODEQL_SHA: '1b1aada464948af03b950897e5eb522f92603cc2' # v3.24.9

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Validate action pinning on main branch
  validate-pinning:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Check action pinning
        run: |
          echo "Validating action pinning policy for main branch..."
          echo "All actions must be pinned by SHA digest on main branch"
          # This is a placeholder - in production, use a dedicated action-pinning validator

  # Security check job - runs before all other jobs
  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '22'
      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: 9
      - name: Run security checks
        run: |
          chmod +x ./scripts/security-check.sh
          ./scripts/security-check.sh
        env:
          CI: true

  # Matrix build for TypeScript packages
  build-matrix:
    needs: [security-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - name: shared-sdk
            path: services/shared-sdk
          - name: project-generator
            path: services/project-generator
          - name: vision-agent
            path: services/vision-agent
          - name: inventory-agent
            path: services/inventory-agent
          - name: ui
            path: ui

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: 9

      - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: |
            pnpm-lock.yaml
            ${{ matrix.package.path }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared-sdk first (if not building shared-sdk)
        if: matrix.package.name != 'shared-sdk'
        run: pnpm --filter @ade/shared-sdk build

      - name: Lint ${{ matrix.package.name }}
        run: pnpm --filter @ade/${{ matrix.package.name }} lint
        continue-on-error: true

      - name: Build ${{ matrix.package.name }}
        run: pnpm --filter @ade/${{ matrix.package.name }} build

      - name: Test ${{ matrix.package.name }}
        run: pnpm --filter @ade/${{ matrix.package.name }} test
        continue-on-error: true

  # SBOM generation for UI package
  generate-sbom:
    needs: [build-matrix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: 9

      - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate CycloneDX SBOM for UI
        run: |
          cd ui
          npx @cyclonedx/cyclonedx-npm --output-format json --output-file sbom.json
        continue-on-error: true

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: ui-sbom
          path: ui/sbom.json
          retention-days: 90
        if: always()

  # npm audit gating for UI
  audit-gate:
    needs: [build-matrix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: pnpm/action-setup@a3252b78c470c02df07e9d59298aecedc3ccdd6d # v3.0.0
        with:
          version: 9

      - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit for UI
        run: |
          cd ui
          pnpm audit --audit-level=high
        continue-on-error: true

  # Policy gate - placeholder for policy checks
  policy-gate:
    needs: [build-matrix]
    runs-on: ubuntu-latest
    steps:
      - name: Policy validation
        run: |
          echo "Running policy validation checks..."
          echo "✓ Policy gate passed"

  # Quota gate - placeholder for quota checks
  quota-gate:
    needs: [build-matrix]
    runs-on: ubuntu-latest
    steps:
      - name: Quota validation
        run: |
          echo "Running quota validation checks..."
          echo "✓ Quota gate passed"

  # CodeQL security analysis
  codeql-analysis:
    needs: [build-matrix]
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Initialize CodeQL
        uses: github/codeql-action/init@1b1aada464948af03b950897e5eb522f92603cc2 # v3.24.9
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@1b1aada464948af03b950897e5eb522f92603cc2 # v3.24.9

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@1b1aada464948af03b950897e5eb522f92603cc2 # v3.24.9

  # Deploy gate - requires all security and policy checks
  deploy-gate:
    needs: [security-check, policy-gate, quota-gate, audit-gate, codeql-analysis]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy gate check
        run: |
          echo "All security and policy gates passed"
          echo "Ready for deployment"

  # Deploy to Cloud Run (placeholder)
  deploy:
    needs: [deploy-gate]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: project-generator
            path: services/project-generator
            concurrency: 250
            cpu-throttling: true
          - name: vision-agent
            path: services/vision-agent
            concurrency: 80
            cpu-throttling: false
          - name: inventory-agent
            path: services/inventory-agent
            concurrency: 150
            cpu-throttling: true
          - name: ui
            path: ui
            concurrency: 200
            cpu-throttling: true

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'your-gcp-project-id' }}
      GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
      ARTIFACT_REGISTRY: ${{ secrets.GCP_REGION || 'us-central1' }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID || 'your-gcp-project-id' }}/ade-images

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@35b0e87d162680511bf346c299f71c9c5c379033 # v2.1.1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        if: secrets.GCP_SA_KEY != ''
        continue-on-error: true

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200 # v2.1.0
        continue-on-error: true

      - name: Configure Docker for Artifact Registry
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet
          else
            echo "Skipping Docker auth - no GCP credentials"
          fi
        continue-on-error: true

      - name: Build and push Docker image
        run: |
          echo "Building ${{ matrix.service.name }}..."
          if [ -f "${{ matrix.service.path }}/Dockerfile" ]; then
            docker build \
              --cache-from ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:latest \
              -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:${{ github.sha }} \
              -t ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:latest \
              -f ${{ matrix.service.path }}/Dockerfile \
              .
            
            if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
              docker push ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:${{ github.sha }}
              docker push ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:latest
            else
              echo "Skipping push - no GCP credentials"
            fi
          else
            echo "No Dockerfile found for ${{ matrix.service.name }}"
          fi
        continue-on-error: true

      - name: Deploy to Cloud Run
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            gcloud run deploy ${{ matrix.service.name }} \
              --image ${{ env.ARTIFACT_REGISTRY }}/${{ matrix.service.name }}:${{ github.sha }} \
              --region ${{ env.GCP_REGION }} \
              --platform managed \
              --min-instances 0 \
              --max-instances 100 \
              --concurrency ${{ matrix.service.concurrency }} \
              --cpu-throttling=${{ matrix.service.cpu-throttling }} \
              --allow-unauthenticated \
              --quiet || echo "Deploy skipped - service not configured"
          else
            echo "Skipping deployment - no GCP credentials"
          fi
        continue-on-error: true
